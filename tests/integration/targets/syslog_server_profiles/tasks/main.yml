---
# Integration tests for syslog_server_profiles module

- name: Set test vars
  ansible.builtin.set_fact:
    profile_name: "ansible_int_test_syslog"
    folder_name: "Texas"
    provider:
      client_id: "{{ client_id }}"
      client_secret: "{{ client_secret }}"
      tsg_id: "{{ tsg_id }}"
      log_level: "INFO"

- name: Clean up any test objects
  cdot65.scm.syslog_server_profiles:
    provider: "{{ provider }}"
    name: "{{ profile_name }}"
    folder: "{{ folder_name }}"
    state: "absent"
  ignore_errors: true

- name: Create a basic syslog server profile
  cdot65.scm.syslog_server_profiles:
    provider: "{{ provider }}"
    name: "{{ profile_name }}"
    servers:
      server1:
        name: "server1"
        server: "192.168.1.100"
        transport: "UDP"
        port: 514
        format: "BSD"
        facility: "LOG_USER"
    folder: "{{ folder_name }}"
    state: "present"
  register: create_result

- name: Verify creation
  ansible.builtin.assert:
    that:
      - create_result.changed
      - create_result.syslog_server_profile is defined
      - create_result.syslog_server_profile.name == profile_name
      - create_result.syslog_server_profile.servers.server1.transport == "UDP"
      - create_result.syslog_server_profile.folder == folder_name

- name: Test idempotence
  cdot65.scm.syslog_server_profiles:
    provider: "{{ provider }}"
    name: "{{ profile_name }}"
    servers:
      server1:
        name: "server1"
        server: "192.168.1.100"
        transport: "UDP"
        port: 514
        format: "BSD"
        facility: "LOG_USER"
    folder: "{{ folder_name }}"
    state: "present"
  register: idempotence_result

- name: Verify idempotence
  ansible.builtin.assert:
    that:
      - not idempotence_result.changed
      - idempotence_result.syslog_server_profile is defined

- name: Update the profile
  cdot65.scm.syslog_server_profiles:
    provider: "{{ provider }}"
    name: "{{ profile_name }}"
    servers:
      server1:
        name: "server1"
        server: "192.168.1.200"  # Updated server
        transport: "UDP"
        port: 514
        format: "BSD"
        facility: "LOG_USER"
    format:
      traffic: "hostname,$time,$src,$dst,$proto,$sport,$dport"
    folder: "{{ folder_name }}"
    state: "present"
  register: update_result

- name: Verify update
  ansible.builtin.assert:
    that:
      - update_result.changed
      - update_result.syslog_server_profile.servers.server1.server == "192.168.1.200"
      - update_result.syslog_server_profile.format.traffic is defined

- name: Delete the profile
  cdot65.scm.syslog_server_profiles:
    provider: "{{ provider }}"
    name: "{{ profile_name }}"
    folder: "{{ folder_name }}"
    state: "absent"
  register: delete_result

- name: Verify deletion
  ansible.builtin.assert:
    that:
      - delete_result.changed