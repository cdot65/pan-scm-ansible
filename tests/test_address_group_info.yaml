---
- name: Test Address Group Info Module
  hosts: localhost
  gather_facts: false
  vars_files:
    - vault.yaml
  vars:
    provider:
      client_id: "{{ client_id }}"
      client_secret: "{{ client_secret }}"
      tsg_id: "{{ tsg_id }}"
      log_level: "INFO"
  tasks:
    # Create test objects
    - name: Create ansible_test_network1 address object with ip_netmask
      cdot65.scm.address:
        provider: "{{ provider }}"
        name: "ansible_test_network1"
        description: "An address object with ip_netmask"
        ip_netmask: "192.168.1.0/24"
        folder: "Texas"
        state: "present"

    - name: Create ansible_test_network2 address object with ip_netmask
      cdot65.scm.address:
        provider: "{{ provider }}"
        name: "ansible_test_network2"
        description: "An address object with ip_netmask"
        ip_netmask: "192.168.2.0/24"
        folder: "Texas"
        state: "present"

    - name: Create a static address group for testing
      cdot65.scm.address_group:
        provider: "{{ provider }}"
        name: "Test_Static_Group_Info"
        description: "A static address group for testing info module"
        static:
          - "ansible_test_network1"
          - "ansible_test_network2"
        folder: "Texas"
        state: "present"

    - name: Create a dynamic address group for testing
      cdot65.scm.address_group:
        provider: "{{ provider }}"
        name: "Test_Dynamic_Group_Info"
        description: "A dynamic address group for testing info module"
        dynamic:
          filter: "'tag1' or 'tag2'"
        folder: "Texas"
        state: "present"

    # Test address_group_info module functionality
    - name: Get information about a specific address group
      cdot65.scm.address_group_info:
        provider: "{{ provider }}"
        name: "Test_Static_Group_Info"
        folder: "Texas"
      register: specific_info

    - name: Display specific address group info
      debug:
        var: specific_info
        verbosity: 1

    - name: Verify specific address group info
      assert:
        that:
          - specific_info.address_group is defined
          - specific_info.address_group.name == "Test_Static_Group_Info"
          - specific_info.address_group.description == "A static address group for testing info module"
          - specific_info.address_group.static is defined
          - specific_info.address_group.static | length == 2
          - "'ansible_test_network1' in specific_info.address_group.static"
          - "'ansible_test_network2' in specific_info.address_group.static"

    - name: List all address groups in the folder
      cdot65.scm.address_group_info:
        provider: "{{ provider }}"
        folder: "Texas"
      register: all_groups

    - name: Display all address groups
      debug:
        var: all_groups
        verbosity: 1

    - name: Verify all address groups
      assert:
        that:
          - all_groups.address_groups is defined
          - all_groups.address_groups | length >= 2

    # Skip tag tests since we don't have pre-created tags
    - name: Skip tag filter tests
      debug:
        msg: "Skipping tag filter tests as they require pre-created tags"

    - name: List only static address groups
      cdot65.scm.address_group_info:
        provider: "{{ provider }}"
        folder: "Texas"
        types: ["static"]
      register: static_groups

    - name: Display static address groups
      debug:
        var: static_groups
        verbosity: 1

    - name: Verify static address groups
      assert:
        that:
          - static_groups.address_groups is defined
          - static_groups.address_groups | selectattr('name', 'eq', 'Test_Static_Group_Info') | list | length == 1
          - static_groups.address_groups | selectattr('name', 'eq', 'Test_Dynamic_Group_Info') | list | length == 0

    - name: List only dynamic address groups
      cdot65.scm.address_group_info:
        provider: "{{ provider }}"
        folder: "Texas"
        types: ["dynamic"]
      register: dynamic_groups

    - name: Display dynamic address groups
      debug:
        var: dynamic_groups
        verbosity: 1

    - name: Verify dynamic address groups
      assert:
        that:
          - dynamic_groups.address_groups is defined
          - dynamic_groups.address_groups | selectattr('name', 'eq', 'Test_Dynamic_Group_Info') | list | length == 1
          - dynamic_groups.address_groups | selectattr('name', 'eq', 'Test_Static_Group_Info') | list | length == 0

    # Cleanup test objects
    - name: Delete the address groups
      cdot65.scm.address_group:
        provider: "{{ provider }}"
        name: "{{ item }}"
        folder: "Texas"
        state: "absent"
      loop:
        - "Test_Static_Group_Info"
        - "Test_Dynamic_Group_Info"

    - name: Clean up the address objects
      cdot65.scm.address:
        provider: "{{ provider }}"
        name: "{{ item }}"
        folder: "Texas"
        state: "absent"
      loop:
        - "ansible_test_network1"
        - "ansible_test_network2"