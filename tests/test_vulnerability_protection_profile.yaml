---
# Test playbook for vulnerability_protection_profile module
- name: Test SCM Vulnerability Protection Profile Module CRUD Operations
  hosts: localhost
  gather_facts: false
  vars_files:
    - vault.yaml
  vars:
    timestamp: "{{ '%y%m%d%H%M'|strftime }}"
    profile_name: "Vuln_Profile_{{ timestamp }}"
    profile_name2: "Vuln_Profile2_{{ timestamp }}"
    provider:
      client_id: "{{ client_id }}"
      client_secret: "{{ client_secret }}"
      tsg_id: "{{ tsg_id }}"
      log_level: "INFO"

  tasks:
    # ==========================================
    # INITIAL CLEANUP
    # ==========================================
    - name: Remove test vulnerability protection profile objects if they exist
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ item }}"
        folder: "Texas" 
        state: "absent"
      loop:
        - "{{ profile_name }}"
        - "{{ profile_name2 }}"
      ignore_errors: yes
      tags: 
        - dev-cleanup

    # Create standard dev tags for testing (commented out due to tag module path issue)
    # - name: Create standard dev tags for testing
    #   cdot65.scm.tag:
    #     provider: "{{ provider }}"
    #     name: "{{ item }}"
    #     folder: "Texas"
    #     state: "present"
    #   loop:
    #     - "dev-ansible"
    #     - "dev-automation"
    #     - "dev-test"
    #     - "dev-cicd"
    #   ignore_errors: yes
    #   tags:
    #     - dev-cleanup

    - name: Set task tags
      set_fact:
        task_tags: 
          - "dev-ansible"
          - "dev-automation"
          - "dev-test"
          - "vuln-protection"

    # ==========================================
    # CREATE OPERATIONS
    # ==========================================
    - name: Create a vulnerability protection profile with basic rules
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        description: "Basic vulnerability protection profile for testing"
        folder: "Texas"
        rules:
          - name: "Block-Critical-Vulnerabilities"
            severity: ["critical"]
            category: "any"
            host: "any"
            action: {"reset_both": {}}
            packet_capture: "single-packet"
            cve: ["any"]
            vendor: ["any"]
          - name: "Alert-High-Vulnerabilities"
            severity: ["high"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
        state: "present"
      register: create_result
      tags:
        - dev-ansible
        - dev-test

    - name: Debug creation result
      debug:
        var: create_result
        verbosity: 1
      tags:
        - dev-test

    - name: Verify profile creation
      assert:
        that:
          - create_result.changed == true
          - create_result.vulnerability_protection_profile.name is defined
          - create_result.vulnerability_protection_profile.folder == "Texas"
          - create_result.vulnerability_protection_profile.rules | length == 2
        fail_msg: "Profile creation failed"
        success_msg: "Successfully created basic vulnerability protection profile"
      tags:
        - dev-test

    - name: Create a comprehensive vulnerability protection profile
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ profile_name2 }}"
        description: "Advanced vulnerability protection profile with specific settings"
        folder: "Texas"
        rules:
          - name: "Block-Critical-RCE"
            severity: ["critical"]
            category: "code-execution"
            host: "server"
            action: {"reset_both": {}}
            packet_capture: "extended-capture"
            cve: ["CVE-2021-44228"]
            vendor: ["any"]
          - name: "Block-SQL-Injection"
            severity: ["critical", "high"]
            category: "sql-injection"
            host: "server"
            action: {"reset_client": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
          - name: "Alert-XSS"
            severity: ["high", "medium"]
            category: "code-execution"
            host: "client"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
        threat_exception:
          - name: "DevEx"
            packet_capture: "single-packet"
            action: {"alert": {}}
            exempt_ip:
              - name: "10.0.2.0/24"
            notes: "Exception for dev environment testing"
        state: "present"
      register: create_result2
      tags:
        - dev-ansible
        - dev-test

    - name: Debug comprehensive profile creation result
      debug:
        var: create_result2
        verbosity: 1
      tags:
        - dev-test

    - name: Verify comprehensive profile creation
      assert:
        that:
          - create_result2.changed == true
          - create_result2.vulnerability_protection_profile.name is defined
          - create_result2.vulnerability_protection_profile.folder == "Texas"
          - create_result2.vulnerability_protection_profile.rules | length == 3
          - create_result2.vulnerability_protection_profile.threat_exception | length == 1
        fail_msg: "Comprehensive profile creation failed"
        success_msg: "Successfully created comprehensive vulnerability protection profile"
      tags:
        - dev-test

    # ==========================================
    # CREATE IDEMPOTENCY TEST
    # ==========================================
    - name: Test idempotency (re-run creation with same parameters)
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        description: "Basic vulnerability protection profile for testing"
        folder: "Texas"
        rules:
          - name: "Block-Critical-Vulnerabilities"
            severity: ["critical"]
            category: "any"
            host: "any"
            action: {"reset_both": {}}
            packet_capture: "single-packet"
            cve: ["any"]
            vendor: ["any"]
          - name: "Alert-High-Vulnerabilities"
            severity: ["high"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
        state: "present"
      register: idempotent_result
      tags:
        - dev-ansible
        - dev-test

    - name: Verify create idempotency behavior
      assert:
        that:
          - idempotent_result.changed == false
        fail_msg: "Module failed idempotency test"
        success_msg: "Vulnerability Protection Profile module passed create idempotency test"
      tags:
        - dev-test

    # ==========================================
    # READ OPERATIONS
    # ==========================================
    - name: Get vulnerability protection profile information
      cdot65.scm.vulnerability_protection_profile_info:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        folder: "Texas"
      register: read_result
      tags:
        - dev-ansible
        - dev-test

    - name: Debug read result
      debug:
        var: read_result
        verbosity: 1
      tags:
        - dev-test

    - name: Verify read operation
      assert:
        that:
          - read_result.vulnerability_protection_profile.name is defined
          - read_result.vulnerability_protection_profile.folder == "Texas"
          - read_result.vulnerability_protection_profile.description == "Basic vulnerability protection profile for testing"
          - read_result.vulnerability_protection_profile.rules | length == 2
        fail_msg: "Profile read operation failed"
        success_msg: "Successfully read vulnerability protection profile information"
      tags:
        - dev-test

    # ==========================================
    # UPDATE OPERATIONS
    # ==========================================
    - name: Update vulnerability protection profile with additional rules
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        description: "Updated vulnerability protection profile"
        folder: "Texas"
        rules:
          - name: "Block-Critical-Vulnerabilities"
            severity: ["critical"]
            category: "any"
            host: "any"
            action: {"reset_both": {}}
            packet_capture: "single-packet"
            cve: ["any"]
            vendor: ["any"]
          - name: "Alert-High-Vulnerabilities"
            severity: ["high"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
          - name: "Monitor-Medium-Vulnerabilities"
            severity: ["medium"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
        state: "present"
      register: update_result
      tags:
        - dev-ansible
        - dev-test

    - name: Debug update result
      debug:
        var: update_result
        verbosity: 1
      tags:
        - dev-test

    - name: Verify profile update
      assert:
        that:
          - update_result.changed == true
          - update_result.vulnerability_protection_profile.description == "Updated vulnerability protection profile"
          - update_result.vulnerability_protection_profile.rules | length == 3
        fail_msg: "Profile update failed"
        success_msg: "Successfully updated vulnerability protection profile"
      tags:
        - dev-test

    # ==========================================
    # UPDATE IDEMPOTENCY TEST
    # ==========================================
    - name: Test update idempotency (re-run update with same parameters)
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        description: "Updated vulnerability protection profile"
        folder: "Texas"
        rules:
          - name: "Block-Critical-Vulnerabilities"
            severity: ["critical"]
            category: "any"
            host: "any"
            action: {"reset_both": {}}
            packet_capture: "single-packet"
            cve: ["any"]
            vendor: ["any"]
          - name: "Alert-High-Vulnerabilities"
            severity: ["high"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
          - name: "Monitor-Medium-Vulnerabilities"
            severity: ["medium"]
            category: "any"
            host: "any"
            action: {"alert": {}}
            packet_capture: "disable"
            cve: ["any"]
            vendor: ["any"]
        state: "present"
      register: update_idempotent_result
      tags:
        - dev-ansible
        - dev-test

    - name: Verify update idempotency behavior
      assert:
        that:
          - update_idempotent_result.changed == false
        fail_msg: "Module failed update idempotency test"
        success_msg: "Vulnerability Protection Profile module passed update idempotency test"
      tags:
        - dev-test

    # ==========================================
    # DELETE OPERATIONS
    # ==========================================
    - name: Delete vulnerability protection profiles
      cdot65.scm.vulnerability_protection_profile:
        provider: "{{ provider }}"
        name: "{{ item }}"
        folder: "Texas"
        state: "absent"
      register: delete_result
      loop:
        - "{{ profile_name }}"
        - "{{ profile_name2 }}"
      tags:
        - dev-ansible
        - dev-test

    - name: Debug delete result
      debug:
        var: delete_result
        verbosity: 1
      tags:
        - dev-test

    - name: Verify vulnerability protection profiles were deleted
      assert:
        that:
          - delete_result.results[0].changed == true
          - delete_result.results[1].changed == true
        fail_msg: "Profile deletion failed"
        success_msg: "Successfully deleted all vulnerability protection profiles"
      tags:
        - dev-test

    - name: Check if profile still exists (should fail)
      cdot65.scm.vulnerability_protection_profile_info:
        provider: "{{ provider }}"
        name: "{{ profile_name }}"
        folder: "Texas"
      register: verify_delete_result
      ignore_errors: yes
      tags:
        - dev-ansible
        - dev-test

    - name: Verify profile deletion
      assert:
        that:
          - verify_delete_result.failed == true
        fail_msg: "Profile still exists after deletion"
        success_msg: "Confirmed profile was properly deleted"
      tags:
        - dev-test

    # ==========================================
    # FINAL CLEANUP
    # ==========================================
    # Delete standard dev tags (commented out due to tag module path issue)
    # - name: Delete standard dev tags used for testing
    #   cdot65.scm.tag:
    #     provider: "{{ provider }}"
    #     name: "{{ item }}"
    #     folder: "Texas"
    #     state: "absent"
    #   loop:
    #     - "dev-ansible"
    #     - "dev-automation"
    #     - "dev-test"
    #     - "dev-cicd"
    #   ignore_errors: yes
    #   tags:
    #     - dev-cleanup

    - name: Cleanup completed
      debug:
        msg: "Test cleanup completed"
      tags:
        - dev-test